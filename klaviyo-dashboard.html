<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lunchbox Klaviyo Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #0a0a0a;
      --card: #141414;
      --border: #262626;
      --text: #fafafa;
      --muted: #a1a1aa;
      --accent: #3D1CB1;
      --green: #22c55e;
      --red: #ef4444;
      --yellow: #eab308;
      --blue: #3b82f6;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .logo h1 {
      font-size: 1.5rem;
      font-weight: 700;
    }

    .logo span {
      background: var(--accent);
      padding: 0.25rem 0.75rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .last-updated {
      font-size: 0.75rem;
      color: var(--muted);
    }

    /* Goals Banner */
    .goals-banner {
      background: linear-gradient(135deg, rgba(61, 28, 177, 0.15), rgba(34, 197, 94, 0.1));
      border: 1px solid var(--accent);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
    }

    .goal-item {
      display: flex;
      flex-direction: column;
    }

    .goal-item .label {
      font-size: 0.7rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 0.25rem;
    }

    .goal-item .target {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--green);
    }

    .goal-item .current {
      font-size: 0.875rem;
      color: var(--muted);
    }

    .goal-item .progress-bar {
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      margin-top: 0.5rem;
      overflow: hidden;
    }

    .goal-item .progress-fill {
      height: 100%;
      background: var(--green);
      border-radius: 2px;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .metric-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
    }

    .metric-card .label {
      font-size: 0.75rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
    }

    .metric-card .value {
      font-size: 2rem;
      font-weight: 700;
    }

    .metric-card .sub {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 0.25rem;
    }

    .section {
      margin-bottom: 2rem;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .section-title {
      font-size: 1.25rem;
      font-weight: 600;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .chart-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
    }

    .chart-card h3 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }

    .chart-container {
      position: relative;
      height: 250px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      text-align: left;
      padding: 1rem;
      border-bottom: 1px solid var(--border);
    }

    th {
      font-size: 0.75rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 600;
    }

    td {
      font-size: 0.875rem;
    }

    tr:hover {
      background: rgba(255,255,255,0.02);
    }

    .status {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .status.live {
      background: rgba(34, 197, 94, 0.1);
      color: var(--green);
    }

    .status.draft {
      background: rgba(234, 179, 8, 0.1);
      color: var(--yellow);
    }

    .status.manual {
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
    }

    .back-link {
      color: var(--muted);
      text-decoration: none;
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .back-link:hover {
      color: var(--text);
    }

    .channel-badge {
      display: inline-block;
      padding: 0.125rem 0.5rem;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .channel-badge.email {
      background: rgba(61, 28, 177, 0.2);
      color: #8b5cf6;
    }

    .channel-badge.sms {
      background: rgba(34, 197, 94, 0.2);
      color: var(--green);
    }

    .highlight { color: var(--green); }
    .highlight-yellow { color: var(--yellow); }
    .highlight-red { color: var(--red); }
    .highlight-blue { color: var(--blue); }

    /* Test Ideas Log */
    .test-log {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }

    .test-log-header {
      background: linear-gradient(90deg, var(--accent), #6d28d9);
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .test-log-header h2 {
      font-size: 1rem;
      font-weight: 600;
    }

    .test-category {
      border-bottom: 1px solid var(--border);
    }

    .test-category:last-child {
      border-bottom: none;
    }

    .test-category-header {
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255,255,255,0.02);
      cursor: pointer;
    }

    .test-category-header h3 {
      font-size: 0.9rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .test-category-header .impact {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
    }

    .impact.high { background: rgba(34, 197, 94, 0.15); color: var(--green); }
    .impact.medium { background: rgba(234, 179, 8, 0.15); color: var(--yellow); }

    .test-list {
      padding: 0 1.5rem 1rem;
    }

    .test-item {
      padding: 1rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 0.75rem;
      background: rgba(255,255,255,0.01);
    }

    .test-item:last-child {
      margin-bottom: 0;
    }

    .test-item h4 {
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .test-item h4 .priority {
      font-size: 0.65rem;
      padding: 0.15rem 0.4rem;
      border-radius: 3px;
      background: var(--accent);
    }

    .test-item p {
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 0.5rem;
    }

    .test-item .metrics {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .test-item .metric {
      font-size: 0.7rem;
      color: var(--muted);
    }

    .test-item .metric strong {
      color: var(--text);
    }

    .insight-callout {
      background: rgba(59, 130, 246, 0.1);
      border-left: 3px solid var(--blue);
      padding: 1rem;
      margin: 1rem 1.5rem;
      border-radius: 0 8px 8px 0;
    }

    .insight-callout p {
      font-size: 0.85rem;
      color: var(--muted);
    }

    .insight-callout strong {
      color: var(--blue);
    }

    @media (max-width: 768px) {
      .container { padding: 1rem; }
      .charts-grid { grid-template-columns: 1fr; }
      header { flex-direction: column; gap: 1rem; align-items: flex-start; }
      .metrics-grid { grid-template-columns: repeat(2, 1fr); }
      .goals-banner { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <a href="index.html" class="back-link">‚Üê Back</a>
        <h1>Lunchbox Klaviyo</h1>
        <span>Dashboard</span>
      </div>
      <div class="last-updated">Last 365 Days ¬∑ Updated: <span id="update-time">Loading...</span></div>
    </header>

    <!-- 2026 Goals Banner -->
    <div class="goals-banner">
      <div class="goal-item">
        <span class="label">2026 Goal: Campaign Click Rate</span>
        <span class="target">+15% ‚Üí 0.91%</span>
        <span class="current">Current: 0.79%</span>
        <div class="progress-bar">
          <div class="progress-fill" style="width: 87%"></div>
        </div>
      </div>
      <div class="goal-item">
        <span class="label">2026 Goal: Flow Revenue</span>
        <span class="target">+15% ‚Üí $1.04M</span>
        <span class="current">Current: $906K</span>
        <div class="progress-bar">
          <div class="progress-fill" style="width: 87%"></div>
        </div>
      </div>
      <div class="goal-item">
        <span class="label">Revenue Needed to Hit Goal</span>
        <span class="target">+$136K</span>
        <span class="current">From flow optimization</span>
      </div>
    </div>

    <!-- Summary Metrics -->
    <div class="metrics-grid" id="summary-metrics">
      <div class="metric-card">
        <div class="label">Total Recipients</div>
        <div class="value" id="total-recipients">-</div>
        <div class="sub" id="recipients-sub">-</div>
      </div>
      <div class="metric-card">
        <div class="label">Total Revenue</div>
        <div class="value highlight" id="total-revenue">-</div>
        <div class="sub" id="revenue-sub">-</div>
      </div>
      <div class="metric-card">
        <div class="label">Email Click Rate</div>
        <div class="value highlight-yellow" id="avg-click-rate">-</div>
        <div class="sub">Target: 0.91%</div>
      </div>
      <div class="metric-card">
        <div class="label">Flow Revenue</div>
        <div class="value" id="flow-revenue">-</div>
        <div class="sub">Target: $1.04M</div>
      </div>
      <div class="metric-card">
        <div class="label">Avg Open Rate</div>
        <div class="value" id="avg-open-rate">-</div>
        <div class="sub">Email campaigns</div>
      </div>
      <div class="metric-card">
        <div class="label">Total Conversions</div>
        <div class="value" id="total-conversions">-</div>
        <div class="sub" id="conversions-sub">-</div>
      </div>
    </div>

    <!-- Test Ideas Log -->
    <div class="section">
      <div class="section-header">
        <h2 class="section-title">üß™ Test Ideas Log</h2>
      </div>
      
      <div class="test-log">
        <div class="test-log-header">
          <h2>Optimization Roadmap for +15% Goals</h2>
          <span style="font-size: 0.75rem; opacity: 0.8;">Based on flow & campaign analysis</span>
        </div>

        <div class="insight-callout">
          <p><strong>Key Insight:</strong> Your top flow generates $502K (55% of flow revenue) with 9.76% click rate. Meanwhile, 3 flows with 50K+ recipients have &lt;3% click rates despite 90%+ open rates. This "open-click gap" represents your biggest optimization opportunity.</p>
        </div>

        <!-- Flow Revenue Tests -->
        <div class="test-category">
          <div class="test-category-header">
            <h3>üìà Flow Revenue Tests</h3>
            <span class="impact high">High Impact ¬∑ +$136K potential</span>
          </div>
          <div class="test-list">
            <div class="test-item">
              <h4><span class="priority">P1</span> Welcome Flow CTA Optimization</h4>
              <p>Your main welcome flow has 85% opens but only 9.76% clicks. Test: larger/bolder CTA buttons, single focused CTA vs multiple, urgency copy ("Limited stock"), and product imagery in hero position.</p>
              <div class="metrics">
                <span class="metric">Current: <strong>9.76% click</strong></span>
                <span class="metric">Target: <strong>11.2% click (+15%)</strong></span>
                <span class="metric">Revenue at stake: <strong>$502K</strong></span>
              </div>
            </div>
            <div class="test-item">
              <h4><span class="priority">P1</span> High-Open/Low-Click Flow Redesign</h4>
              <p>3 flows show 90%+ open rates but &lt;3% click rates - classic content disconnect. Recipients open but don't act. Test: above-fold product showcase, social proof (reviews), clearer value prop, mobile-first design.</p>
              <div class="metrics">
                <span class="metric">Flows affected: <strong>3</strong></span>
                <span class="metric">Combined recipients: <strong>33K</strong></span>
                <span class="metric">Combined revenue: <strong>$68K</strong></span>
              </div>
            </div>
            <div class="test-item">
              <h4><span class="priority">P2</span> Checkout Abandonment Urgency Sequence</h4>
              <p>$26K from checkout abandonment at only 2% click. Test: countdown timers, "cart expiring" copy, showing exact items left behind with images, social proof ("X people viewing this").</p>
              <div class="metrics">
                <span class="metric">Current: <strong>2.06% click</strong></span>
                <span class="metric">Revenue: <strong>$26K</strong></span>
              </div>
            </div>
            <div class="test-item">
              <h4><span class="priority">P2</span> Cart Abandonment SMS Follow-up</h4>
              <p>SMS has 3.1% click vs 0.79% email. Add SMS touchpoint to cart abandonment flow 2-4 hours after email. Keep it personal: "Hey! Your Lunchbox pack is waiting üéí"</p>
              <div class="metrics">
                <span class="metric">SMS avg click: <strong>3.1%</strong></span>
                <span class="metric">Email avg click: <strong>0.79%</strong></span>
              </div>
            </div>
            <div class="test-item">
              <h4><span class="priority">P3</span> Review Request Monetization</h4>
              <p>Junip Review Blast has 85% opens, $380 revenue - missed opportunity. Add product upsell/cross-sell after review submission. "Thanks for the review! Here's 10% off your next pack."</p>
              <div class="metrics">
                <span class="metric">Recipients: <strong>19.5K</strong></span>
                <span class="metric">Current revenue: <strong>$380</strong></span>
              </div>
            </div>
          </div>
        </div>

        <!-- Campaign Click Tests -->
        <div class="test-category">
          <div class="test-category-header">
            <h3>üéØ Campaign Click Rate Tests</h3>
            <span class="impact high">High Impact ¬∑ Target: 0.79% ‚Üí 0.91%</span>
          </div>
          <div class="test-list">
            <div class="test-item">
              <h4><span class="priority">P1</span> Subject Line A/B Framework</h4>
              <p>Top campaigns hit 5% click while average is 0.79%. Establish A/B testing protocol: Test curiosity gaps ("The one thing festival-goers forget..."), personalization, emoji vs no emoji, length variations.</p>
              <div class="metrics">
                <span class="metric">Best performers: <strong>4-5% click</strong></span>
                <span class="metric">Average: <strong>0.79%</strong></span>
                <span class="metric">Gap: <strong>5x difference</strong></span>
              </div>
            </div>
            <div class="test-item">
              <h4><span class="priority">P1</span> High-Volume Campaign Redesign</h4>
              <p>5 campaigns with 100K+ recipients have &lt;0.5% click - that's millions of impressions underperforming. Audit these for: template issues, dead links, unclear CTAs, irrelevant content for segment.</p>
              <div class="metrics">
                <span class="metric">Recipients affected: <strong>600K+</strong></span>
                <span class="metric">Current click: <strong>0.25-0.44%</strong></span>
              </div>
            </div>
            <div class="test-item">
              <h4><span class="priority">P2</span> Segmentation by Engagement</h4>
              <p>Stop sending to non-engagers - they tank your metrics. Create segments: Hot (opened last 30d), Warm (30-90d), Cold (90d+). Tailor content and frequency by segment.</p>
              <div class="metrics">
                <span class="metric">Expected lift: <strong>+20-30% click rate</strong></span>
                <span class="metric">Deliverability boost: <strong>Yes</strong></span>
              </div>
            </div>
            <div class="test-item">
              <h4><span class="priority">P2</span> SMS Campaign Expansion</h4>
              <p>SMS campaigns average 3.1% click (4x email). Currently 45 SMS vs 123 email campaigns. Opportunity: add SMS versions of top-performing email campaigns.</p>
              <div class="metrics">
                <span class="metric">SMS click rate: <strong>3.1%</strong></span>
                <span class="metric">Email click rate: <strong>0.79%</strong></span>
              </div>
            </div>
            <div class="test-item">
              <h4><span class="priority">P3</span> Interactive Content Test</h4>
              <p>Test interactive elements: polls, quizzes ("Which pack matches your festival style?"), countdown timers for sales. These typically boost engagement 2-3x.</p>
              <div class="metrics">
                <span class="metric">Industry benchmark: <strong>2-3x click lift</strong></span>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Wins -->
        <div class="test-category">
          <div class="test-category-header">
            <h3>‚ö° Quick Wins (This Week)</h3>
            <span class="impact medium">Medium Impact ¬∑ Fast to implement</span>
          </div>
          <div class="test-list">
            <div class="test-item">
              <h4>Activate Draft Flows</h4>
              <p>You have 24 flows in "draft" status including legacy welcome series and cart abandonment. Audit and either delete or activate - dead flows = missed revenue.</p>
            </div>
            <div class="test-item">
              <h4>Add UTM Tracking to All CTAs</h4>
              <p>Ensure every link has proper UTMs for accurate attribution. Format: utm_source=klaviyo&utm_medium=email&utm_campaign=[flow_name]</p>
            </div>
            <div class="test-item">
              <h4>Mobile Preview Audit</h4>
              <p>Check top 5 revenue flows on mobile. If CTAs are below the fold or images are broken, you're losing clicks. 60%+ of opens are mobile.</p>
            </div>
            <div class="test-item">
              <h4>Sunset Unengaged Profiles</h4>
              <p>Profiles with no opens in 180+ days hurt deliverability. Move them to a re-engagement flow or suppress from regular sends.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts -->
    <div class="charts-grid">
      <div class="chart-card">
        <h3>Revenue by Channel</h3>
        <div class="chart-container">
          <canvas id="revenue-chart"></canvas>
        </div>
      </div>
      <div class="chart-card">
        <h3>Engagement Comparison</h3>
        <div class="chart-container">
          <canvas id="engagement-chart"></canvas>
        </div>
      </div>
    </div>

    <!-- Flow vs Campaign Revenue -->
    <div class="charts-grid">
      <div class="chart-card">
        <h3>Revenue: Flows vs Campaigns</h3>
        <div class="chart-container">
          <canvas id="source-chart"></canvas>
        </div>
      </div>
      <div class="chart-card">
        <h3>Top 10 Flows by Revenue</h3>
        <div class="chart-container">
          <canvas id="flows-chart"></canvas>
        </div>
      </div>
    </div>

    <!-- Top Flows Table -->
    <div class="section">
      <div class="section-header">
        <h2 class="section-title">Top Performing Flows</h2>
      </div>
      <div class="chart-card">
        <table id="flows-table">
          <thead>
            <tr>
              <th>Flow Name</th>
              <th>Status</th>
              <th>Recipients</th>
              <th>Open Rate</th>
              <th>Click Rate</th>
              <th>Revenue</th>
              <th>Conv.</th>
            </tr>
          </thead>
          <tbody id="flows-tbody">
          </tbody>
        </table>
      </div>
    </div>

    <!-- Top Campaigns Table -->
    <div class="section">
      <div class="section-header">
        <h2 class="section-title">Top Campaigns by Revenue</h2>
      </div>
      <div class="chart-card">
        <table id="campaigns-table">
          <thead>
            <tr>
              <th>Campaign</th>
              <th>Channel</th>
              <th>Recipients</th>
              <th>Open Rate</th>
              <th>Click Rate</th>
              <th>Revenue</th>
              <th>Conv.</th>
            </tr>
          </thead>
          <tbody id="campaigns-tbody">
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Format helpers
    const formatCurrency = (num) => '$' + Math.round(num).toLocaleString('en-US');
    const formatNumber = (num) => Math.round(num).toLocaleString('en-US');
    const formatPercent = (num) => (num * 100).toFixed(2) + '%';

    // Load data from JSON files
    async function loadData() {
      const [campaignsRes, flowsRes, flowsMetaRes, campaignsMetaRes, lastUpdatedRes] = await Promise.all([
        fetch('data/campaigns.json'),
        fetch('data/flows.json'),
        fetch('data/flows-meta.json'),
        fetch('data/campaigns-meta.json'),
        fetch('data/last-updated.txt')
      ]);

      const campaigns = await campaignsRes.json();
      const flows = await flowsRes.json();
      const flowsMeta = await flowsMetaRes.json();
      const campaignsMeta = await campaignsMetaRes.json();
      const lastUpdated = await lastUpdatedRes.text();

      return {
        campaigns: campaigns.data?.attributes?.results || [],
        flows: flows.data?.attributes?.results || [],
        flowsMeta: flowsMeta.data || [],
        campaignsMeta: campaignsMeta.data || [],
        lastUpdated: lastUpdated.trim()
      };
    }

    // Aggregate campaign data
    function aggregateCampaignData(data) {
      const emailData = data.filter(d => d.groupings.send_channel === 'email');
      const smsData = data.filter(d => d.groupings.send_channel === 'sms');

      const aggregate = (items) => {
        const totals = {
          recipients: 0, opens: 0, clicks: 0, conversions: 0,
          conversion_value: 0, unsubscribes: 0
        };

        items.forEach(item => {
          totals.recipients += item.statistics.recipients || 0;
          totals.opens += item.statistics.opens || 0;
          totals.clicks += item.statistics.clicks || 0;
          totals.conversions += item.statistics.conversions || 0;
          totals.conversion_value += item.statistics.conversion_value || 0;
          totals.unsubscribes += item.statistics.unsubscribes || 0;
        });

        totals.open_rate = totals.recipients > 0 ? totals.opens / totals.recipients : 0;
        totals.click_rate = totals.recipients > 0 ? totals.clicks / totals.recipients : 0;
        totals.count = items.length;
        return totals;
      };

      return { email: aggregate(emailData), sms: aggregate(smsData), all: aggregate(data) };
    }

    // Aggregate flow data
    function aggregateFlowData(data, metadata) {
      const metaMap = {};
      metadata.forEach(f => {
        metaMap[f.id] = { name: f.attributes.name, status: f.attributes.status };
      });

      const flowTotals = {};
      data.forEach(item => {
        const flowId = item.groupings.flow_id;
        if (!flowTotals[flowId]) {
          flowTotals[flowId] = {
            id: flowId,
            name: metaMap[flowId]?.name || flowId,
            status: metaMap[flowId]?.status || 'unknown',
            recipients: 0, opens: 0, clicks: 0, conversions: 0, conversion_value: 0
          };
        }
        flowTotals[flowId].recipients += item.statistics.recipients || 0;
        flowTotals[flowId].opens += item.statistics.opens || 0;
        flowTotals[flowId].clicks += item.statistics.clicks || 0;
        flowTotals[flowId].conversions += item.statistics.conversions || 0;
        flowTotals[flowId].conversion_value += item.statistics.conversion_value || 0;
      });

      Object.values(flowTotals).forEach(flow => {
        flow.open_rate = flow.recipients > 0 ? flow.opens / flow.recipients : 0;
        flow.click_rate = flow.recipients > 0 ? flow.clicks / flow.recipients : 0;
      });

      return Object.values(flowTotals).sort((a, b) => b.conversion_value - a.conversion_value);
    }

    // Render everything
    async function init() {
      try {
        const { campaigns, flows, flowsMeta, campaignsMeta, lastUpdated } = await loadData();

        document.getElementById('update-time').textContent = new Date(lastUpdated).toLocaleString();

        const campaignAgg = aggregateCampaignData(campaigns);
        const flowAgg = aggregateFlowData(flows, flowsMeta);
        const flowTotalRevenue = flowAgg.reduce((sum, f) => sum + f.conversion_value, 0);
        const flowTotalConversions = flowAgg.reduce((sum, f) => sum + f.conversions, 0);

        // Summary metrics
        document.getElementById('total-recipients').textContent = formatNumber(campaignAgg.all.recipients);
        document.getElementById('recipients-sub').textContent = `${formatNumber(campaignAgg.email.count)} email + ${formatNumber(campaignAgg.sms.count)} SMS`;
        
        document.getElementById('total-revenue').textContent = formatCurrency(campaignAgg.all.conversion_value + flowTotalRevenue);
        document.getElementById('revenue-sub').textContent = `Campaigns: ${formatCurrency(campaignAgg.all.conversion_value)} ¬∑ Flows: ${formatCurrency(flowTotalRevenue)}`;
        
        document.getElementById('avg-click-rate').textContent = formatPercent(campaignAgg.email.click_rate);
        document.getElementById('avg-open-rate').textContent = formatPercent(campaignAgg.email.open_rate);
        document.getElementById('flow-revenue').textContent = formatCurrency(flowTotalRevenue);
        
        document.getElementById('total-conversions').textContent = formatNumber(campaignAgg.all.conversions + flowTotalConversions);
        document.getElementById('conversions-sub').textContent = `Campaigns: ${formatNumber(campaignAgg.all.conversions)} ¬∑ Flows: ${formatNumber(flowTotalConversions)}`;

        // Charts
        const chartColors = {
          purple: '#3D1CB1',
          green: '#22c55e',
          blue: '#3b82f6',
          yellow: '#eab308'
        };

        // Revenue by Channel
        new Chart(document.getElementById('revenue-chart'), {
          type: 'doughnut',
          data: {
            labels: ['Email', 'SMS'],
            datasets: [{
              data: [campaignAgg.email.conversion_value, campaignAgg.sms.conversion_value],
              backgroundColor: [chartColors.purple, chartColors.green],
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom', labels: { color: '#a1a1aa' } },
              tooltip: {
                callbacks: {
                  label: (ctx) => `${ctx.label}: ${formatCurrency(ctx.raw)}`
                }
              }
            }
          }
        });

        // Engagement comparison
        new Chart(document.getElementById('engagement-chart'), {
          type: 'bar',
          data: {
            labels: ['Email Campaigns', 'SMS Campaigns', 'Flows (Avg)'],
            datasets: [
              {
                label: 'Open Rate',
                data: [campaignAgg.email.open_rate * 100, 0, flowAgg.slice(0, 10).reduce((sum, f) => sum + f.open_rate, 0) / Math.min(10, flowAgg.length) * 100],
                backgroundColor: chartColors.purple
              },
              {
                label: 'Click Rate',
                data: [campaignAgg.email.click_rate * 100, campaignAgg.sms.click_rate * 100, flowAgg.slice(0, 10).reduce((sum, f) => sum + f.click_rate, 0) / Math.min(10, flowAgg.length) * 100],
                backgroundColor: chartColors.green
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: { beginAtZero: true, grid: { color: '#262626' }, ticks: { color: '#a1a1aa', callback: v => v + '%' } },
              x: { grid: { display: false }, ticks: { color: '#a1a1aa' } }
            },
            plugins: { legend: { position: 'bottom', labels: { color: '#a1a1aa' } } }
          }
        });

        // Flows vs Campaigns revenue
        new Chart(document.getElementById('source-chart'), {
          type: 'doughnut',
          data: {
            labels: ['Campaigns', 'Flows'],
            datasets: [{
              data: [campaignAgg.all.conversion_value, flowTotalRevenue],
              backgroundColor: [chartColors.blue, chartColors.yellow],
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom', labels: { color: '#a1a1aa' } },
              tooltip: {
                callbacks: {
                  label: (ctx) => `${ctx.label}: ${formatCurrency(ctx.raw)}`
                }
              }
            }
          }
        });

        // Top flows horizontal bar
        const top10Flows = flowAgg.slice(0, 10);
        new Chart(document.getElementById('flows-chart'), {
          type: 'bar',
          data: {
            labels: top10Flows.map(f => f.name.length > 25 ? f.name.slice(0, 25) + '...' : f.name),
            datasets: [{
              data: top10Flows.map(f => f.conversion_value),
              backgroundColor: chartColors.purple
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { grid: { color: '#262626' }, ticks: { color: '#a1a1aa', callback: v => '$' + (v/1000).toFixed(0) + 'k' } },
              y: { grid: { display: false }, ticks: { color: '#a1a1aa', font: { size: 10 } } }
            },
            plugins: { legend: { display: false } }
          }
        });

        // Flows table
        const flowsTbody = document.getElementById('flows-tbody');
        top10Flows.forEach(flow => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${flow.name}</td>
            <td><span class="status ${flow.status}">${flow.status}</span></td>
            <td>${formatNumber(flow.recipients)}</td>
            <td>${formatPercent(flow.open_rate)}</td>
            <td>${formatPercent(flow.click_rate)}</td>
            <td class="highlight">${formatCurrency(flow.conversion_value)}</td>
            <td>${formatNumber(flow.conversions)}</td>
          `;
          flowsTbody.appendChild(tr);
        });

        // Campaigns table
        const metaMap = {};
        campaignsMeta.forEach(c => {
          metaMap[c.id] = { name: c.attributes.name, status: c.attributes.status };
        });

        const topCampaigns = [...campaigns].sort((a, b) => b.statistics.conversion_value - a.statistics.conversion_value).slice(0, 15);
        const campaignsTbody = document.getElementById('campaigns-tbody');
        topCampaigns.forEach(campaign => {
          const id = campaign.groupings.campaign_id;
          const meta = metaMap[id] || {};
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${meta.name || id.slice(0, 12) + '...'}</td>
            <td><span class="channel-badge ${campaign.groupings.send_channel}">${campaign.groupings.send_channel}</span></td>
            <td>${formatNumber(campaign.statistics.recipients)}</td>
            <td>${formatPercent(campaign.statistics.open_rate)}</td>
            <td>${formatPercent(campaign.statistics.click_rate)}</td>
            <td class="highlight">${formatCurrency(campaign.statistics.conversion_value)}</td>
            <td>${formatNumber(campaign.statistics.conversions)}</td>
          `;
          campaignsTbody.appendChild(tr);
        });

      } catch (error) {
        console.error('Dashboard error:', error);
        document.querySelector('.container').innerHTML = `
          <div style="color: #ef4444; padding: 2rem; text-align: center;">
            <h2>Failed to load dashboard</h2>
            <p>${error.message}</p>
            <p style="margin-top: 1rem; color: #a1a1aa;">Make sure the data files exist in /data/</p>
          </div>
        `;
      }
    }

    init();
  </script>
</body>
</html>
