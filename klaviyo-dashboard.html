<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lunchbox Klaviyo Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #0a0a0a;
      --card: #141414;
      --border: #262626;
      --text: #fafafa;
      --muted: #a1a1aa;
      --accent: #3D1CB1;
      --green: #22c55e;
      --red: #ef4444;
      --yellow: #eab308;
      --blue: #3b82f6;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; }
    .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border); }
    .logo { display: flex; align-items: center; gap: 1rem; }
    .logo h1 { font-size: 1.5rem; font-weight: 700; }
    .logo span { background: var(--accent); padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
    .last-updated { font-size: 0.75rem; color: var(--muted); }
    .goals-banner { background: linear-gradient(135deg, rgba(61, 28, 177, 0.15), rgba(34, 197, 94, 0.1)); border: 1px solid var(--accent); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; }
    .goal-item { display: flex; flex-direction: column; }
    .goal-item .label { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.25rem; }
    .goal-item .target { font-size: 1.5rem; font-weight: 700; color: var(--green); }
    .goal-item .current { font-size: 0.875rem; color: var(--muted); }
    .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
    .metric-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; }
    .metric-card .label { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem; }
    .metric-card .value { font-size: 1.5rem; font-weight: 700; }
    .metric-card .sub { font-size: 0.7rem; color: var(--muted); margin-top: 0.25rem; }
    .section { margin-bottom: 2rem; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .section-title { font-size: 1.25rem; font-weight: 600; }
    .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
    .chart-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; }
    .chart-card h3 { font-size: 1rem; font-weight: 600; margin-bottom: 1rem; }
    .chart-container { position: relative; height: 200px; }
    table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
    th, td { text-align: left; padding: 0.75rem; border-bottom: 1px solid var(--border); }
    th { font-size: 0.65rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; }
    tr:hover { background: rgba(255,255,255,0.02); }
    .status { display: inline-flex; padding: 0.15rem 0.4rem; border-radius: 999px; font-size: 0.6rem; font-weight: 500; text-transform: uppercase; }
    .status.live { background: rgba(34, 197, 94, 0.15); color: var(--green); }
    .back-link { color: var(--muted); text-decoration: none; font-size: 0.875rem; }
    .back-link:hover { color: var(--text); }
    .channel { font-size: 0.9rem; }
    .highlight { color: var(--green); }
    .highlight-yellow { color: var(--yellow); }
    .highlight-red { color: var(--red); }
    .msg-breakdown { font-size: 0.7rem; color: var(--muted); }
    .msg-item { display: inline-block; margin-right: 0.5rem; }
    .yoy-table { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; margin-bottom: 2rem; }
    .yoy-header { background: linear-gradient(90deg, var(--blue), #6366f1); padding: 1rem 1.5rem; }
    .yoy-header h3 { font-size: 1rem; font-weight: 600; }
    .yoy-up { color: var(--green); }
    .yoy-down { color: var(--red); }
    .yoy-new { color: var(--blue); font-style: italic; }
    .opp-table { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; margin-bottom: 2rem; }
    .opp-header { background: linear-gradient(90deg, var(--yellow), #f59e0b); padding: 1rem 1.5rem; }
    .opp-header h3 { font-size: 1rem; font-weight: 600; color: #000; }
    @media (max-width: 768px) {
      .container { padding: 1rem; }
      .charts-grid { grid-template-columns: 1fr; }
      header { flex-direction: column; gap: 1rem; align-items: flex-start; }
      .metrics-grid { grid-template-columns: repeat(2, 1fr); }
      .goals-banner { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <a href="index.html" class="back-link">‚Üê Back</a>
        <h1>Lunchbox Klaviyo</h1>
        <span>Dashboard</span>
      </div>
      <div class="last-updated">Live Flows Only ¬∑ Updated: <span id="update-time">Loading...</span></div>
    </header>

    <div class="goals-banner">
      <div class="goal-item">
        <span class="label">2026 Goal: Campaign Click Rate</span>
        <span class="target">+15% ‚Üí 0.91%</span>
        <span class="current">Current: 0.79%</span>
      </div>
      <div class="goal-item">
        <span class="label">2026 Goal: Flow Revenue</span>
        <span class="target">+15% ‚Üí $942K</span>
        <span class="current">Current: $819K (2025)</span>
      </div>
      <div class="goal-item">
        <span class="label">2025 vs 2024 Growth</span>
        <span class="target">+472%</span>
        <span class="current">$143K ‚Üí $819K</span>
      </div>
    </div>

    <div class="metrics-grid">
      <div class="metric-card">
        <div class="label">Total Recipients</div>
        <div class="value" id="total-recipients">-</div>
        <div class="sub" id="recipients-sub">-</div>
      </div>
      <div class="metric-card">
        <div class="label">Total Revenue</div>
        <div class="value highlight" id="total-revenue">-</div>
        <div class="sub" id="revenue-sub">-</div>
      </div>
      <div class="metric-card">
        <div class="label">Email Click Rate</div>
        <div class="value highlight-yellow" id="avg-click-rate">-</div>
        <div class="sub">Target: 0.91%</div>
      </div>
      <div class="metric-card">
        <div class="label">Flow Revenue (Live)</div>
        <div class="value" id="flow-revenue">-</div>
        <div class="sub">2025: $819K</div>
      </div>
      <div class="metric-card">
        <div class="label">Avg Open Rate</div>
        <div class="value" id="avg-open-rate">-</div>
        <div class="sub">Email campaigns</div>
      </div>
      <div class="metric-card">
        <div class="label">Total Conversions</div>
        <div class="value" id="total-conversions">-</div>
        <div class="sub" id="conversions-sub">-</div>
      </div>
    </div>

    <!-- Year over Year Comparison -->
    <div class="section">
      <div class="yoy-table">
        <div class="yoy-header">
          <h3>üìä Year-over-Year Flow Performance (Live Flows Only)</h3>
        </div>
        <table>
          <thead>
            <tr>
              <th>Flow Type</th>
              <th>2024 Revenue</th>
              <th>2024 Clicks</th>
              <th>2025 Revenue</th>
              <th>2025 Clicks</th>
              <th>YoY Change</th>
            </tr>
          </thead>
          <tbody id="yoy-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- Opportunities -->
    <div class="section">
      <div class="opp-table">
        <div class="opp-header">
          <h3>üéØ Flow Optimization Opportunities (Live Flows)</h3>
        </div>
        <table>
          <thead>
            <tr>
              <th>Flow</th>
              <th>Issue</th>
              <th>Open</th>
              <th>Click</th>
              <th>Revenue</th>
              <th>Potential</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="opportunities-tbody"></tbody>
        </table>
      </div>
    </div>

    <div class="charts-grid">
      <div class="chart-card">
        <h3>Revenue by Channel</h3>
        <div class="chart-container">
          <canvas id="revenue-chart"></canvas>
        </div>
      </div>
      <div class="chart-card">
        <h3>Flows vs Campaigns</h3>
        <div class="chart-container">
          <canvas id="source-chart"></canvas>
        </div>
      </div>
    </div>

    <!-- Top Flows (Live Only) -->
    <div class="section">
      <div class="section-header">
        <h2 class="section-title">Top Live Flows by Revenue</h2>
      </div>
      <div class="chart-card">
        <table>
          <thead>
            <tr>
              <th>Flow Name</th>
              <th>Recipients</th>
              <th>Open</th>
              <th>Click</th>
              <th>Revenue</th>
              <th>Message Breakdown</th>
            </tr>
          </thead>
          <tbody id="flows-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- Top Campaigns -->
    <div class="section">
      <div class="section-header">
        <h2 class="section-title">Top Campaigns by Revenue</h2>
      </div>
      <div class="chart-card">
        <table>
          <thead>
            <tr>
              <th>Campaign Name</th>
              <th>Ch</th>
              <th>Recipients</th>
              <th>Open</th>
              <th>Click</th>
              <th>Revenue</th>
              <th>Conv</th>
            </tr>
          </thead>
          <tbody id="campaigns-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const formatCurrency = (num) => '$' + Math.round(num).toLocaleString('en-US');
    const formatNumber = (num) => Math.round(num).toLocaleString('en-US');
    const formatPercent = (num) => (num * 100).toFixed(2) + '%';
    const formatPct = (num) => (num * 100).toFixed(1) + '%';

    async function loadData() {
      const [campaignsRes, flowsRes, flowNamesRes, campaignsMetaRes, yoyRes, lastUpdatedRes] = await Promise.all([
        fetch('data/campaigns.json'),
        fetch('data/flows.json'),
        fetch('data/flow-names.json'),
        fetch('data/campaigns-meta.json'),
        fetch('data/yoy-comparison.json'),
        fetch('data/last-updated.txt')
      ]);
      return {
        campaigns: (await campaignsRes.json()).data?.attributes?.results || [],
        flows: (await flowsRes.json()).data?.attributes?.results || [],
        flowNames: await flowNamesRes.json(),
        campaignsMeta: (await campaignsMetaRes.json()).data || [],
        yoy: await yoyRes.json(),
        lastUpdated: (await lastUpdatedRes.text()).trim()
      };
    }

    function aggregateCampaigns(data) {
      const email = data.filter(d => d.groupings.send_channel === 'email');
      const sms = data.filter(d => d.groupings.send_channel === 'sms');
      const agg = (items) => {
        const t = { recipients: 0, opens: 0, clicks: 0, conversions: 0, revenue: 0, count: items.length };
        items.forEach(i => {
          t.recipients += i.statistics.recipients || 0;
          t.opens += i.statistics.opens || 0;
          t.clicks += i.statistics.clicks || 0;
          t.conversions += i.statistics.conversions || 0;
          t.revenue += i.statistics.conversion_value || 0;
        });
        t.open_rate = t.recipients > 0 ? t.opens / t.recipients : 0;
        t.click_rate = t.recipients > 0 ? t.clicks / t.recipients : 0;
        return t;
      };
      return { email: agg(email), sms: agg(sms), all: agg(data) };
    }

    function aggregateFlows(data, names, liveOnly = true) {
      const flows = {};
      data.forEach(item => {
        const fid = item['groupings']['flow_id'];
        const mid = item['groupings']['flow_message_id'];
        const info = names[fid] || { name: fid, status: 'unknown' };
        
        // Skip draft flows if liveOnly
        if (liveOnly && info.status === 'draft') return;
        
        if (!flows[fid]) {
          flows[fid] = {
            id: fid, name: info.name, status: info.status, messages: [],
            totals: { recipients: 0, opens: 0, clicks: 0, revenue: 0, conversions: 0 }
          };
        }
        flows[fid].messages.push({
          id: mid,
          recipients: item.statistics.recipients || 0,
          clicks: item.statistics.clicks || 0,
          click_rate: item.statistics.click_rate || 0,
          revenue: item.statistics.conversion_value || 0
        });
        const t = flows[fid].totals;
        t.recipients += item.statistics.recipients || 0;
        t.opens += item.statistics.opens || 0;
        t.clicks += item.statistics.clicks || 0;
        t.revenue += item.statistics.conversion_value || 0;
        t.conversions += item.statistics.conversions || 0;
      });
      Object.values(flows).forEach(f => {
        f.totals.open_rate = f.totals.recipients > 0 ? f.totals.opens / f.totals.recipients : 0;
        f.totals.click_rate = f.totals.recipients > 0 ? f.totals.clicks / f.totals.recipients : 0;
        f.messages.sort((a, b) => b.revenue - a.revenue);
      });
      return Object.values(flows).sort((a, b) => b.totals.revenue - a.totals.revenue);
    }

    function findOpportunities(flows) {
      return flows
        .filter(f => f.totals.recipients > 1000 && f.totals.open_rate > 0.5 && f.totals.click_rate < 0.04)
        .map(f => ({
          name: f.name,
          open_rate: f.totals.open_rate,
          click_rate: f.totals.click_rate,
          revenue: f.totals.revenue,
          potential: f.totals.revenue > 0 ? f.totals.revenue * 2 : f.totals.recipients * 0.5,
          issue: f.totals.click_rate < 0.02 ? 'Very low clicks' : 'Low clicks',
          action: f.totals.click_rate < 0.02 ? 'Redesign CTAs' : 'A/B test CTAs'
        }))
        .sort((a, b) => b.potential - a.potential)
        .slice(0, 8);
    }

    async function init() {
      try {
        const { campaigns, flows, flowNames, campaignsMeta, yoy, lastUpdated } = await loadData();
        document.getElementById('update-time').textContent = new Date(lastUpdated).toLocaleString();
        
        const campAgg = aggregateCampaigns(campaigns);
        const flowAgg = aggregateFlows(flows, flowNames, true); // Live only
        const flowTotal = flowAgg.reduce((sum, f) => sum + f.totals.revenue, 0);
        const flowConv = flowAgg.reduce((sum, f) => sum + f.totals.conversions, 0);
        
        // Metrics
        document.getElementById('total-recipients').textContent = formatNumber(campAgg.all.recipients);
        document.getElementById('recipients-sub').textContent = `${campAgg.email.count} email + ${campAgg.sms.count} SMS`;
        document.getElementById('total-revenue').textContent = formatCurrency(campAgg.all.revenue + flowTotal);
        document.getElementById('revenue-sub').textContent = `Camp: ${formatCurrency(campAgg.all.revenue)} ¬∑ Flow: ${formatCurrency(flowTotal)}`;
        document.getElementById('avg-click-rate').textContent = formatPercent(campAgg.email.click_rate);
        document.getElementById('flow-revenue').textContent = formatCurrency(flowTotal);
        document.getElementById('avg-open-rate').textContent = formatPct(campAgg.email.open_rate);
        document.getElementById('total-conversions').textContent = formatNumber(campAgg.all.conversions + flowConv);
        document.getElementById('conversions-sub').textContent = `Camp: ${formatNumber(campAgg.all.conversions)} ¬∑ Flow: ${formatNumber(flowConv)}`;
        
        // YoY Table
        const yoyTbody = document.getElementById('yoy-tbody');
        let total2024 = { revenue: 0, clicks: 0 };
        let total2025 = { revenue: 0, clicks: 0 };
        
        Object.entries(yoy.by_type).forEach(([type, data]) => {
          const d2024 = data['2024'] || { revenue: 0, clicks: 0 };
          const d2025 = data['2025'] || { revenue: 0, clicks: 0 };
          
          total2024.revenue += d2024.revenue || 0;
          total2024.clicks += d2024.clicks || 0;
          total2025.revenue += d2025.revenue || 0;
          total2025.clicks += d2025.clicks || 0;
          
          let yoyClass = 'yoy-new';
          let yoyText = 'NEW';
          if (d2024.revenue > 0) {
            const change = ((d2025.revenue - d2024.revenue) / d2024.revenue) * 100;
            yoyClass = change >= 0 ? 'yoy-up' : 'yoy-down';
            yoyText = (change >= 0 ? '+' : '') + change.toFixed(0) + '%';
          }
          
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><strong>${type}</strong></td>
            <td>${formatCurrency(d2024.revenue || 0)}</td>
            <td>${formatNumber(d2024.clicks || 0)}</td>
            <td>${formatCurrency(d2025.revenue || 0)}</td>
            <td>${formatNumber(d2025.clicks || 0)}</td>
            <td class="${yoyClass}">${yoyText}</td>
          `;
          yoyTbody.appendChild(tr);
        });
        
        // Totals row
        const totalYoyChange = ((total2025.revenue - total2024.revenue) / total2024.revenue) * 100;
        const totalTr = document.createElement('tr');
        totalTr.style.background = 'rgba(255,255,255,0.05)';
        totalTr.style.fontWeight = '600';
        totalTr.innerHTML = `
          <td>TOTAL</td>
          <td>${formatCurrency(total2024.revenue)}</td>
          <td>${formatNumber(total2024.clicks)}</td>
          <td class="highlight">${formatCurrency(total2025.revenue)}</td>
          <td>${formatNumber(total2025.clicks)}</td>
          <td class="yoy-up">+${totalYoyChange.toFixed(0)}%</td>
        `;
        yoyTbody.appendChild(totalTr);
        
        // Opportunities
        const opps = findOpportunities(flowAgg);
        const oppTbody = document.getElementById('opportunities-tbody');
        opps.forEach(o => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><strong>${o.name}</strong></td>
            <td style="color: var(--yellow)">${o.issue}</td>
            <td>${formatPct(o.open_rate)}</td>
            <td style="color: var(--red)">${formatPct(o.click_rate)}</td>
            <td>${formatCurrency(o.revenue)}</td>
            <td class="highlight">${formatCurrency(o.potential)}</td>
            <td>${o.action}</td>
          `;
          oppTbody.appendChild(tr);
        });
        
        // Charts
        new Chart(document.getElementById('revenue-chart'), {
          type: 'doughnut',
          data: { labels: ['Email', 'SMS'], datasets: [{ data: [campAgg.email.revenue, campAgg.sms.revenue], backgroundColor: ['#3D1CB1', '#22c55e'], borderWidth: 0 }] },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#a1a1aa' } } } }
        });
        
        new Chart(document.getElementById('source-chart'), {
          type: 'doughnut',
          data: { labels: ['Campaigns', 'Flows'], datasets: [{ data: [campAgg.all.revenue, flowTotal], backgroundColor: ['#3b82f6', '#eab308'], borderWidth: 0 }] },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#a1a1aa' } } } }
        });
        
        // Flows table (live only)
        const flowTbody = document.getElementById('flows-tbody');
        flowAgg.slice(0, 15).forEach(f => {
          const msgBreakdown = f.messages.slice(0, 4).map((m, i) => {
            const label = f.name.split(' ')[0].replace('10M:', '').replace('Retention', 'Ret').trim() || 'Email';
            return `<span class="msg-item">${label} #${i+1}: ${formatCurrency(m.revenue)}</span>`;
          }).join('');
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><strong>${f.name}</strong> <span class="status live">live</span></td>
            <td>${formatNumber(f.totals.recipients)}</td>
            <td>${formatPct(f.totals.open_rate)}</td>
            <td>${formatPct(f.totals.click_rate)}</td>
            <td class="highlight">${formatCurrency(f.totals.revenue)}</td>
            <td><div class="msg-breakdown">${msgBreakdown}</div></td>
          `;
          flowTbody.appendChild(tr);
        });
        
        // Campaigns table
        const campMeta = {};
        campaignsMeta.forEach(c => { campMeta[c.id] = c.attributes.name; });
        const sortedCamps = [...campaigns].sort((a, b) => b.statistics.conversion_value - a.statistics.conversion_value);
        const campTbody = document.getElementById('campaigns-tbody');
        sortedCamps.slice(0, 20).forEach(c => {
          const name = campMeta[c.groupings.campaign_id] || `Campaign ${c.groupings.campaign_id.slice(0, 8)}`;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${name}</td>
            <td><span class="channel">${c.groupings.send_channel === 'email' ? 'üìß' : 'üì±'}</span></td>
            <td>${formatNumber(c.statistics.recipients)}</td>
            <td>${formatPct(c.statistics.open_rate)}</td>
            <td>${formatPct(c.statistics.click_rate)}</td>
            <td class="highlight">${formatCurrency(c.statistics.conversion_value)}</td>
            <td>${formatNumber(c.statistics.conversions)}</td>
          `;
          campTbody.appendChild(tr);
        });
        
      } catch (error) {
        console.error('Dashboard error:', error);
        document.querySelector('.container').innerHTML = `<div style="color: #ef4444; padding: 2rem;"><h2>Failed to load</h2><p>${error.message}</p></div>`;
      }
    }
    init();
  </script>
</body>
</html>
